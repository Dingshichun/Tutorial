# SSH(Secure Shell) 密钥原理
## (1) 简介
SSH 是一种协议标准，目的是实现远程登录和其它安全网络服务等。  
为什么需要 SSH ？保证数据的安全，首先想到的是对数据进行加密，加密的方式主要有两种：
* 对称加密(也称秘钥加密)。  
即加密和解密使用同一套秘钥。比如客户端使用秘钥 A 给数据加密之后发送给服务器，服务器也使用秘钥 A 对加密后的数据进行解密，是能成功解密得到数据的。  
对称加密的加密强度高，很难破解，但是怎么安全地保存秘钥是个问题。一旦秘钥泄露，系统就没有安全性可言。为了解决这个问题，非对称加密应运而生。非对称加密有两个密钥：公钥、私钥。
* 非对称加密  
使用两个密钥的特性：公钥加密后的密文，只能通过对应的私钥进行解密。而通过公钥推理出私钥的可能性微乎其微。  
## (2) 公钥和私钥加密流程、缺点和解决办法
### (2.1) 公钥和私钥加密流程
* 1、远程 Server 收到 Client 端用户 TopGun 的登录请求，Server 把自己的公钥发给用户。
* 2、Client 使用这个公钥，将密码进行加密。
* 3、Client 将加密的密码发送给 Server 端。
* 4、远程 Server 用自己的私钥，解密登录密码，然后验证其合法性。
* 5、若验证结果，给 Client 相应的响应。

### (2.2) 缺点和解决办法
* **缺点**  
私钥是 Server 端独有，这就保证了 Client 的登录信息即使在网络传输过程中被窃据，也没有私钥进行解密，保证了数据的安全性，这充分利用了非对称加密的特性。  
但是这样也不能保证安全，因为无法确保 client 收到的公钥就是来自 server 。如果攻击者中途拦截 client 的登录请求，然后向其发送自己的公钥，client 使用该攻击者的公钥进行数据加密，然后发回，攻击者收到加密数据后直接使用自己的私钥进行解密，就窃取了 client 的登录信息。这就是 **中间人攻击**。  
* **解决办法**  
1. 基于口令的认证。即 client 自己对公钥进行确定，通常在第一次登录的时候，系统会提示对公钥进行确认，确定是否连接。  
2. 基于公钥认证。  
* 1、Client 将自己的公钥存放在 Server 上，追加在文件 authorized_keys 中。
* 2、Server 端接收到 Client 的连接请求后，会在 authorized_keys 中匹配到 Client 的公钥 pubKey ，并生成随机数 R ，用 Client 的公钥对该随机数进行加密得到 pubKey ，然后将加密后信息发送给 Client 。
* 3、Client 端通过私钥进行解密得到随机数 R ，然后对随机数 R 和本次会话的 SessionKey 利用 MD5 生成摘要 Digest1 ，发送给 Server 端。
* 4、Server 端会也会对 R 和 SessionKey 利用同样摘要算法生成 Digest2 。
* 5、Server 端会最后比较 Digest1 和 Digest2 是否相同，完成认证过程。
## (3) 生成 SSH 密钥
ssh-keygen 是用于生成密钥的工具，一台设备仅能使用一对密钥，多了会识别错误。
```
# 在终端输入下面命令生成密钥文件 id_rsa(私钥)、id_rsa.pub(公钥) ，可能还会生成 known_hosts 和 authorized_keys 文件，known_hosts 用于保存已认证的远程主机 ID ，authorized_keys 用于保存已授权的客户端公钥。
ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa
# -t 指定加密类型为 rsa ，
# -P 指定 passphrase ，用于确保私钥的安全
# -f 指定密钥存放目录(公钥和私钥默认在同一个目录)
```
需要注意的是：**一台主机可能既是 Client ，也是 Server 。所以会同时拥有 authorized_keys 和 known_hosts**。

配置好后可使用 SSH 登录远程主机
```
# 以用户名 user，登录远程主机 host
$ ssh user@host

# 如果本地用户和远程用户相同，则用户名可省去
$ ssh host

# SSH 默认端口 22，可以用参数 p 修改端口
$ ssh -p 2017 user@host
```
